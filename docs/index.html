<!-- References: -->
<!-- http://bl.ocks.org/d3noob/7030f35b72de721622b8 -->
<!-- http://bl.ocks.org/phoebebright/3131368 -->
<!-- onclick: https://stackoverflow.com/questions/46713258/detecting-keypress-in-d3-js -->

<!-- A general note -- this script uses d3.js v4. Cv3 and v4
are often not compatabile, unfortunately, so if encountering
unexpected errors...check this. -->

<!DOCTYPE html>
<meta charset="utf-8">
<head>
<!-- I personally do not like our current font choice. To edit? -->
<link rel="stylesheet" type="text/css" href="map.css">
<style>

  /* Size and style and positioning of overlay box*/
  .modal {
  position: fixed;
  width: 300px;
  height: 100px;
  top: 40%;
  left: 70%;
  margin-top: -50px; /* Negative half of height. */
  margin-left: -50px; /* Negative half of width. */
  text-align: center;
  background-color: rgba(250,218,94,1);
  color: black;
  border-radius: 5px;
  text-align: center;
  z-index: 11; /* 1px higher than the overlay layer */
  word-wrap: break-word;
}


#leftarrow {
    border-right:15px solid black;
    border-bottom:15px solid black;
    width:50px;
    height:50px;
    transform: rotate(135deg);
    margin-top:40px;
    margin-left:40px; /* move away from left window edge slightly */
}

#leftarrow {
  display: flex;
  margin-top: auto;
  /*margin-left: auto;*/
}

#arrow {
    border-right:15px solid black;
    border-bottom:15px solid black;
    width:50px;
    height:50px;
    transform: rotate(-45deg);
    margin-top:40px;
    margin-left:40px;
}

#arrow {
  display: flex;
  margin-top: auto;
}

</style>
</head>

<!-- <script src="https://d3js.org/d3.v3.min.js"></script>  -->
<script src="https://d3js.org/d3.v4.min.js"></script> 
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script> 
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> 
<script src="https://d3js.org/topojson.v2.min.js"></script>
<script src="https://d3js.org/d3-axis.v1.min.js"></script>
<script src="https://d3js.org/d3-drag.v1.min.js"></script>
<script src="https://cdn.rawgit.com/vast-engineering/jquery-popup-overlay/1.7.13/jquery.popupoverlay.js"></script>
<script src="js/keybinding.js"></script>
<body onclick="off()" onresize="off()">

   <div class="modal" id="overlay"> 
    To advance/rewind the narrative, or click the arrows or use the right/left keys on your keyboard.
    (Click to remove this dialogue box)
    </div>
  

</body>

<script type="text/javascript">
// Overlay control:
function on() {
  document.getElementById("overlay").style.display = "block";
};
function off() {
  document.getElementById("overlay").style.display = "none";
}

// Layout page with CSS grid
// Add 'tutorial' with HTML overlay
// On click, increment count variable and move through steps of the story, each of which is
// outlined in its own function?

// Key components
// Draw line, fade line, change axis. Works well for drawing single lines. 
// What if we want to get more complicated?
// Do we want plots with more than one line? How to best visualize? How to implement?

// Set up grid, on which we can place objects.
var grid = d3.select("body")
  .append("div")
  .attr("id", "grid")
  .attr("class", "grid");

// Initial text    
// In future, select 'title_text' to replace this headline.
grid
  .append("div")
  .attr("class", "row_divs")
  .append("h1")
  .attr("id", "title_text")
  .text("The unemployment rate has recovered since the financial crisis.");

// Global variables, setup, housekeeping.
var margin = {top: 20, right: 20, bottom: 50, left: 100},
  width = 960 - margin.left - margin.right,
  height = 500 - margin.top - margin.bottom;
var parseTime = d3.timeParse("%Y-%m-%d");
transitionTime = 3000; // What feels best? Should it always be the same?
how_far_below_min_for_y_scale = .1 // We don't want y axis to start 
                                   // at the minimum value, so use this
                                   // parameter to extend axis a bit below 
                                   // minimum value.
var percentFormat = d3.format(".1%"); 

// Add left arrow. By appending this before the chart
// svg, it automatically goes to the left.
var leftarrow = grid.append("div").attr("id", "leftarrow");

// SVG element contains our main chart.
var svg = grid.append("div").append("svg")
  .attr('id', 'emp_chart')
  .attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom)
  .append("g")
  .attr("transform",
        "translate(" + margin.left + "," + margin.top + ")");


// Import the data.
d3.csv("employment.csv", function(error, data) {
  if (error) throw error;

  // D3 scales
  // (use xx and yy as names to differentiate 
  // between x and y components of d3.line())
  var xx = d3.scaleTime().range([0, width]);
  var yy = d3.scaleLinear().range([height, 0]);

  // Format the data as time and numeric
  data.forEach(function(d) {
    d.date = parseTime(d.DATE);
    d.unrate = +d.UNRATE/100; // Divide by 100 to format as %.
    d.notinLF = +d.notinLF/100;//+d.LFPR;
    d.m_not_lfpr = +d.m_not_lfpr/100;
    d.w_not_lfpr = +d.w_not_lfpr/100;
  });

  // Functions:

  // - draw_lines
  // -- input x and list of y value series to draw

  // - draw_axes

  function draw_lines(data, x, y, color, line_id){
    // y can be array of y values.

    // Range (extent) of dates (or x vales)
    xx.domain(d3.extent(data, function(d) { return d[x]; }));

    if (y.length > 1) {
      // Draw lines on properly scaled y axis
      min = Math.pow(10, 1000) // Big positive number as initial min. 
      max = Math.pow(-10, 1001) // Big negative number as initial max. 
      // Anything greater than this will then become max.
      for (i = 0; i < y.length; i++){
        local_min = d3.min(data, function(d) { return d[y[i]]; })
        if (local_min < min){
          min = local_min;
        }
        local_max = d3.max(data, function(d) { return d[y[i]]; })
        if (local_max > max){
          max = local_max;
        }
      }
      yy.domain([.75*min, 1.1*max])
    }
    else {  
      yy.domain([d3.min(data, function(d) { return d[y]; }) - 
      how_far_below_min_for_y_scale*d3.min(data, function(d) { return d[y]; }), 
        d3.max(data, function(d) { return d[y]; })]);
    };

    for (i = 0; i < y.length; i++) { 
      path = svg.append("path")
          .datum(data)
          .attr("fill", "none")
          .attr("id", line_id)
          .attr("stroke", color[i])
          .attr("stroke-linejoin", "round")
          .attr("stroke-linecap", "round")
          .attr("stroke-width", 2.5)
          .attr("d", d3.line()
            .x(function(d) { return xx(d[x]); })
            .y(function(d) { return yy(d[y[i]]); }));

      // Mechanism for animating line path left to right.
      totalLength = path.node().getTotalLength();
      path
        .attr("stroke-dasharray", totalLength + " " + totalLength)
        .attr("stroke-dashoffset", totalLength)
        .transition()
        .duration(transitionTime)
        .attr("stroke-dashoffset", 0);
    }

  };

  function split_line(initial_line_ids, list_of_new_lines){
    colors = ['red', 'green']
    for (i = 0; i < list_of_new_lines.length; i++) { 
      d3.select('#'+initial_line_ids[i]).transition().duration(1000).delay(1000).attr("d", d3.line()
            .x(function(d) { return xx(d['date']); })
            .y(function(d) { return yy(d[list_of_new_lines[i]]); }))
      .attr('stroke', colors[i])
      .attr('id', list_of_new_lines[i]);
    }
  };

  // Add initial axes.

  function axes_labels(xAxis, yAxis, x_axis_label, y_axis_label){
    // Axes labels:
    // X axis label:
    xAxis.append("text")             
      .attr("transform",
            "translate(" + (width/2) + " ," + 
                           (margin.top + 20) + ")")
      .style("text-anchor", "middle")
      .style('fill','black')
      .text(x_axis_label);
    // Y axis label
    xAxis.append("text").attr("transform", "rotate(-90)")
      .attr("y", -3*margin.top)
      .attr("x",(height / 2))
      .attr("dy", "1em")
      .style("text-anchor", "middle")
      .style('fill','black')
      .text(y_axis_label); 

  };

  function addInitialAxes(x_axis_series, y_axis_series){
    xx.domain(d3.extent(data, function(d) { return d[x_axis_series]; }));
    yy.domain([d3.min(data, function(d) { return d[y_axis_series]; }) - 
      how_far_below_min_for_y_scale*d3.min(data, function(d) { return d[y_axis_series]; }), 
        d3.max(data, function(d) { return d[y_axis_series]; })]);
    // Add the Y Axis initially
    var yAxis = svg.append("g")
      .attr('id', 'unemployment_axis')
      .call(d3.axisLeft().tickFormat(percentFormat).scale(yy));
    // Add the X Axis
    var xAxis = svg.append("g")
      .attr("transform", "translate(0," + height + ")")
      .attr('id','xaxis')
      .call(d3.axisBottom(xx).ticks(10).tickFormat(d3.timeFormat("%Y")));
    // Call axes_labels function to add labels.
    axes_labels(xAxis,yAxis,'Date', 'Percent (%)');
  }
  addInitialAxes('date', 'unrate');

  function fade_line(line_id) {
  // Fade out.
  // https://groups.google.com/forum/#!msg/d3-js/nkIpeZ60Sas/RZEIhmrsI0cJ
    d3.select(line_id) //#emp_line
     .style("opacity", 1)
     .transition().duration(400).style("opacity", 0);
    };

  function fadeAxis(old_axis_id, new_axis_id, new_series){
    // yy.domain([.25,.45]);
    if (new_series.length > 1) {
      min_of_series_0 = d3.min(data, function(d) { return d[new_series[0]]; })
      min_of_series_1 = d3.min(data, function(d) { return d[new_series[1]]; })
      max_of_series_0 = d3.max(data, function(d) { return d[new_series[0]]; })
      max_of_series_1 = d3.max(data, function(d) { return d[new_series[1]]; })
      min = Math.min(min_of_series_0, min_of_series_1)
      max = Math.max(max_of_series_0, max_of_series_1)
      yy.domain([min, max])
    }
    else {
        yy.domain( [d3.min(data, function(d) { return d[new_series]; }) 
                   - how_far_below_min_for_y_scale*d3.min(data, function(d) { return d[new_series]; }), 
                    1.1*d3.max(data, function(d) { return d[new_series]; })]);
    };
    d3.select("body")
      .select('#'+old_axis_id) // change out the old y axis
      .attr("id", new_axis_id) //give a new id tag to the new axis
      .transition()
      .duration(transitionTime)
      .call(d3.axisLeft().tickFormat(percentFormat).scale(yy));
  };

  function change_slide_title(new_title){
    d3.select("#title_text")
     .transition()
     .duration(transitionTime/2)
     .style("opacity", 0)
     .transition()
     .text(new_title)
     .duration(transitionTime/2)
     .style("opacity", 1);
  };

// On right arrow key, progress thru story. 
  function story(){
    if (count == 0 ) {
      change_slide_title('The unemployment rate has recovered since the financial crisis.');
      fade_line('lfpr_line');
      draw_lines(data, 'date', ['unrate'], ['steelblue'], 'emp_line'); 
    };
    if (count == 1 ) {
      // d3.select('svg').remove();
      change_slide_title('This story is incomplete, however.');
    };
    if (count == 2 ) {
      fade_line('#emp_line');
    //   if (d3.select('#emp_line').empty()) {
    // }
    // else {
    //   fade_line('#emp_line');
    // }
      fadeAxis(old_axis_id = 'unemployment_axis', new_axis_id = 'lfpr_axis', new_series = ['notinLF']);
      change_slide_title('The percent of Americans out of the labor force has been rising sharply.');
      draw_lines(data, 'date', ['notinLF'], ['darkred'], 'lfpr_line'); 
      draw_lines(data, 'date', ['notinLF'], ['darkred'], 'lfpr_line2'); 

    };
    if (count == 3){
     
      // d3.select('#lfpr_line').transition().duration(1000).delay(1000).attr("d",  d3.line()
      //       .x(function(d) { return xx(d['date']); })
      //       .y(function(d) { return yy(d['m_not_lfpr']); }));
      fadeAxis(old_axis_id = 'lfpr_axis', new_axis_id = 'm_not_lfpr_axis', new_series = ['m_not_lfpr','w_not_lfpr']);
      split_line(['lfpr_line', 'lfpr_line2'], ['m_not_lfpr', 'w_not_lfpr']);
      change_slide_title('In particular, this rise has been steeper for men.');
    
      svg.append("text")
    .attr("transform", "translate("+width*.9+",60)")
    .attr("dy", ".35em")
    .attr("text-anchor", "start")
    .style("fill", "green")
    .attr('id','women_text')
    .transition()
    .delay(transitionTime)
    .text("Women");

    svg.append("text")
    .attr("transform", "translate("+width*.9+",320)")
    .attr("dy", ".35em")
    .transition()
    .delay(transitionTime)
    // .duration(3000)
    .attr("text-anchor", "start")
    .style("fill", "red")
    .text("Men");

    };
    if (count == 4){
      d3.select('#women_text')
     .style("opacity", 1)
     .transition().duration(400).style("opacity", 0);

      d3.select('#women_text').remove();


     d3.select('#w_not_lfpr') //#emp_line
     .style("opacity", 1)
     .transition().duration(400).style("opacity", 0);

   d3.select('#w_not_lfpr').remove();


    fadeAxis(old_axis_id = 'm_not_lfpr_axis', new_axis_id = 'm_not_lfpr_axis2', new_series = ['m_not_lfpr']);

     d3.select('#m_not_lfpr').transition().duration(transitionTime).attr("d", d3.line() //.delay(1000)
            .x(function(d) { 
              return xx(d['date']); })
            .y(function(d) { return yy(d['m_not_lfpr']); }))

     // d3.select('#w_not_lfpr').transition().duration(transitionTime).remove();
      // d3.select('#women_text').transition().duration(transitionTime).remove();
      change_slide_title('Even after the recession\'s end, this rise has not stopped.');

      // var today = new Date();
      var recessionStart = new Date('February 1, 2008');
      var recessionEnd = new Date('February 1, 2010');

      var area = d3.area()
          .x(function(d){ return xx(d.date); })
          .y0(function(d) { return yy(d['m_not_lfpr']); })
          .y1(height);
          // .y0(height)
          // .y1(function(d) { return yy(d['m_not_lfpr']); });
          console.log(data)

      svg.append("path")
          .datum(data.filter(function(d){return recessionStart < d['date'] && d['date'] < recessionEnd;}))
          // .datum(data)
          .attr("fill", "LightCoral")
          .attr("stroke-linejoin", "round")
          .attr("stroke-linecap", "round")
          .attr("stroke-width", 2.5)
          .style("opacity", 0)
     	.transition().duration(transitionTime).style("opacity", 1)
     //      .attr('transform', 'translate(0, '+height+')') // <---- here
    	// .transition()
	    // // .ease('linear') //, 1, .3)
	    // .duration(transitionTime)
	    // .attr('transform', 'translate(0, 0)') // <---- then here
          .attr("d", area);

      // d3.line().x([xx(today), xx(today)]).y([yy(0), yy(1)]);

      // svg.append("line")
      //   .attr("x1", xx(today))  //<<== change your code here
      //   .attr("y1", 0)
      //   .attr("x2", xx(today))  //<<== and here
      //   .attr("y2", 1)
      //   .attr("id", "vertical line")
      //   .style("stroke-width", 2)
      //   .style("stroke", "red")
      //   .style("fill", "black");

      // fade_line('#lfpr_line');
    // if (d3.select('#emp_line').empty()) {
    //     console.log('Nothing to do.')
    //   }
    //   else {
    //     fade_line('#lfpr_line');
    //   }
    //   d3.select("#emp_line").remove(); // Get rid of emp line element from count 0 so we don't redraw.
      // fadeAxis(old_axis_id = 'lfpr_axis', new_axis_id = 'm_not_lfpr_axis', new_series = ['m_not_lfpr','w_not_lfpr']);
      // draw_lines(data=data, x='date', y=['m_not_lfpr', 'w_not_lfpr'], color=['purple','green'], line_id = 'm_not_lfpr_line');
      // draw_line(data=data, x='date', y='w_not_lfpr', color='green', line_id = 'w_not_lfpr_line'), all_lines = ['m_not_lfpr', 'w_not_lfpr'];

      // change_slide_title('For men, in particular, the number out of the labor force has seen a sharp rise.');
    };
 //    if (count == 3){
  // // Split LFPR line into male and female lfpr
 //      fade_line('#m_not_lfpr_line');
 //      fadeAxis(old_axis_id = 'm_not_lfpr_axis', new_axis_id = 'w_not_lfpr_axis', new_series = 'w_not_lfpr');
 //      draw_line(data=data, x='date', y='w_not_lfpr', color='green', line_id = 'w_not_lfpr_line');
 //      change_slide_title('For women...');
 //    };
  };

  draw_lines(data, 'date', ['unrate'], ['steelblue'], 'emp_line'); 

  var count = 0;

  // Control story with arrow keys.
  d3.select("body")
   .on("keydown", function(e) { 
      d3.event.preventDefault();  // Prevent scrolling with arrow key.
      if (d3.event.keyCode == 39) { // right arrow  
          count +=1; // progress story
          story(count);   
      };
      if (d3.event.keyCode == 37) { // left arrow  
        count -=1; // progress story
        story(count);   
      };
    });

  var arrow = grid
    .append("div")
    .attr("id", "arrow")
    .on("click", function() {
      count+=1;
      story(count);
    }); // Add arrow to control animations.

  leftarrow.on("click", function() {
    count-=1;
    story(count);
  }); // Add story functionalities to left arrow (which we already made above.

// Close d3.csv.
});

</script>